<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Submit-a-Text | Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body {
      font-family: 'Inter', system-ui, sans-serif;
      min-height: 100%;
      transition: background 0.6s ease, color 0.6s ease;
    }

    body.dark {
      background: radial-gradient(ellipse at top right, #0b0c1a 0%, #030617 80%);
      color: #f1f5f9;
    }

    body.light {
      background: linear-gradient(to bottom right, #edf2f7, #e0e7ff);
      color: #1f2937;
    }

    .container {
      max-width: 1150px;
      margin: 40px auto;
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      backdrop-filter: blur(16px);
      box-shadow: 0 0 40px rgba(59,130,246,0.2);
      padding: 30px 40px;
      transition: all 0.5s ease;
    }

    body.light .container {
      background: white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    th {
      background: rgba(59,130,246,0.1);
      color: #93c5fd;
    }

    body.light th {
      background: #f9fafb;
      color: #374151;
    }

    tr:hover {
      background: rgba(59,130,246,0.08);
    }

    body.light tr:hover {
      background: #f3f4f6;
    }

    .btn {
      display: inline-block;
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .btn-resend {
      background: #3b82f6;
      color: white;
      box-shadow: 0 0 10px rgba(59,130,246,0.5);
    }

    .btn-resend:hover { background: #2563eb; }

    .btn-delete {
      background: #ef4444;
      color: white;
      box-shadow: 0 0 10px rgba(239,68,68,0.5);
    }

    .btn-delete:hover { background: #dc2626; }

    .btn-outline {
      background: transparent;
      border: 1px solid rgba(147,197,253,0.4);
      color: #93c5fd;
    }

    .btn-outline:hover {
      background: rgba(59,130,246,0.1);
      border-color: #60a5fa;
    }

    .alert {
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
      animation: fadein 0.3s;
    }

    .alert-success {
      background: rgba(16,185,129,0.2);
      color: #6ee7b7;
      border: 1px solid #34d399;
    }

    .alert-error {
      background: rgba(239,68,68,0.2);
      color: #fca5a5;
      border: 1px solid #ef4444;
    }

    @keyframes fadein {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #settingsModal {
      animation: fadeIn 0.25s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.96); }
      to { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body class="dark">

  <div class="container">

    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-semibold tracking-wide"> Submit-a-Text Dashboard</h1>
      <div class="flex items-center gap-4">
        <button id="modeToggle" class="btn btn-outline">Dark Mode / Light Mode</button>
        <button id="settingsBtn" class="btn btn-outline">‚öôÔ∏è Settings</button>
        <a href="/logout" class="btn btn-delete">Logout</a>
      </div>
    </div>

    <!-- Alerts -->
    {% if msg == "sent" %}
      <div class="alert alert-success">‚úÖ Message sent successfully!</div>
    {% elif msg == "deleted" %}
      <div class="alert alert-error">üóëÔ∏è Record deleted successfully.</div>
    {% endif %}

    <!-- Filters -->
    <form method="get" action="/admin" class="flex flex-wrap items-end gap-4 mb-6">
      <div>
        <label for="limit" class="block text-sm font-medium">Show</label>
        <select name="limit" id="limit" class="border rounded-md p-2 w-28 bg-transparent text-inherit">
          <option value="10" {% if limit == 10 %}selected{% endif %}>Top 10</option>
          <option value="50" {% if limit == 50 %}selected{% endif %}>Top 50</option>
          <option value="100" {% if limit == 100 %}selected{% endif %}>Top 100</option>
        </select>
      </div>

      <div>
        <label for="from_date" class="block text-sm font-medium">From</label>
        <input type="date" name="from_date" id="from_date" value="{{ from_date or '' }}" class="border rounded-md p-2 bg-transparent text-inherit">
      </div>

      <div>
        <label for="to_date" class="block text-sm font-medium">To</label>
        <input type="date" name="to_date" id="to_date" value="{{ to_date or '' }}" class="border rounded-md p-2 bg-transparent text-inherit">
      </div>

      <div>
        <label for="search" class="block text-sm font-medium">Search (Phone / Member ID)</label>
        <input type="text" name="search" id="search" placeholder="e.g. +1305..." value="{{ search or '' }}" class="border rounded-md p-2 w-56 bg-transparent text-inherit">
      </div>

      <div>
        <button type="submit" class="btn btn-resend">Filter</button>
      </div>

      <div>
        <a href="/admin?today=true" class="btn btn-outline">Today</a>
      </div>
    </form>

    <!-- Table -->
    <div class="overflow-x-auto">
      <table class="min-w-full rounded-lg overflow-hidden">
        <thead>
          <tr>
            <th>ID</th>
            <th>Phone</th>
            <th>Member ID</th>
            <th>Office</th>
            <th>Plan Type</th>
            <th>Created On</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for sale in sales %}
          <tr>
            <td>{{ sale.id }}</td>
            <td>{{ sale.phone }}</td>
            <td>{{ sale.health_id or '' }}</td>
            <td>{{ sale.office }}</td>
            <td>{{ sale.plan_type }}</td>
            <td>{{ sale.created_on.strftime("%Y-%m-%d") if sale.created_on else "" }}</td>
            <td>
              <a href="/admin/resend/{{ sale.id }}" class="btn btn-resend">Resend</a>
              <a href="/admin/delete/{{ sale.id }}" class="btn btn-delete" onclick="return confirm('Delete this record?')">Delete</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden">
    <div class="bg-gray-900 text-gray-100 rounded-lg shadow-xl w-full max-w-md p-6 relative">
      <button id="closeSettings" class="absolute top-3 right-3 text-gray-400 hover:text-gray-200 text-2xl">&times;</button>
      <h2 class="text-xl font-semibold mb-4">‚öôÔ∏è Message Settings</h2>

      <form id="settingsForm" class="space-y-4">
        <label class="block font-medium mb-1">Default SMS Message</label>
        <textarea id="messageText" rows="4" class="w-full border rounded-md p-3 bg-transparent text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>

        <div class="flex justify-end gap-2">
          <button type="button" id="cancelSettings" class="btn btn-outline">Cancel</button>
          <button type="submit" class="btn btn-resend">Save</button>
        </div>
      </form>

      <div id="settingsAlert" class="mt-4 text-sm hidden"></div>
    </div>
  </div>

  <!-- JS -->
  <script>
    // Theme Toggle
    const modeToggle = document.getElementById('modeToggle');
    const body = document.body;
    modeToggle.addEventListener('click', () => {
      if (body.classList.contains('dark')) {
        body.classList.remove('dark');
        body.classList.add('light');
      } else {
        body.classList.remove('light');
        body.classList.add('dark');
      }
    });

    // Auto-hide alerts
    setTimeout(() => {
      document.querySelectorAll('.alert').forEach(el => el.style.display = 'none');
    }, 3000);

    // Settings modal logic
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettings = document.getElementById('closeSettings');
    const cancelSettings = document.getElementById('cancelSettings');
    const settingsForm = document.getElementById('settingsForm');
    const messageText = document.getElementById('messageText');
    const settingsAlert = document.getElementById('settingsAlert');

    settingsBtn.addEventListener('click', async () => {
      settingsModal.classList.remove('hidden');
      const resp = await fetch('/api/get-settings');
      const data = await resp.json();
      messageText.value = data.message || '';
    });

    function closeModal() {
      settingsModal.classList.add('hidden');
      settingsAlert.classList.add('hidden');
    }
    closeSettings.addEventListener('click', closeModal);
    cancelSettings.addEventListener('click', closeModal);

    settingsForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const resp = await fetch('/api/save-settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: messageText.value })
      });
      const data = await resp.json();
      settingsAlert.classList.remove('hidden');
      settingsAlert.textContent = data.ok ? '‚úÖ Message updated successfully!' : '‚ùå Failed to update.';
      settingsAlert.className = data.ok ? 'mt-4 text-green-400' : 'mt-4 text-red-400';
      setTimeout(closeModal, 1500);
    });
  </script>
</body>
</html>
